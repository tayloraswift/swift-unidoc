name: package

on:
    push:
        branches: [ master ]
    pull_request:
        branches: [ master ]

jobs:
    linux:
        runs-on: ubuntu-22.04
        name: Ubuntu 22.04
        env:
            UNIDOC_ENABLE_INDEXSTORE: "1"
            AWS_S3_ACCESS_SECRET: ${{ secrets.AWS_S3_ACCESS_SECRET }}
            SWIFTLY_PLATFORM: "ubuntu22.04"
            SWIFTLY_SWIFT: "5.10.1"
            UNIDOC_PLATFORM: "linux-$(uname -i)"
            UNIDOC_VERSION: ${{ github.head_ref || github.ref_name }}

        steps:
            -   name: Setup Swiftly
                run: |
                    curl -L https://swiftlang.github.io/swiftly/swiftly-install.sh > swiftly.sh
                    chmod +x swiftly.sh
                    ./swiftly.sh -y -p $SWIFTLY_PLATFORM

            -   name: Setup Swift
                run: |
                    swiftly install $SWIFTLY_SWIFT
                    swiftly list
                    swiftly use $SWIFTLY_SWIFT

            -   name: Checkout repository
                uses: actions/checkout@v3

            -   name: Build release
                run: |
                    swift --version
                    swift build -c release \
                        -Xcxx -I/usr/lib/swift \
                        -Xcxx -I/usr/lib/swift/Block

            -   name: Upload binaries
                run: |
                    .build/release/unidoc-publish \
                        unidoc-tools \
                        /unidoc/$UNIDOC_VERSION/$UNIDOC_PLATFORM/unidoc \
                        --secret $AWS_S3_ACCESS_SECRET

